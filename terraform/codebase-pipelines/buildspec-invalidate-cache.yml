version: 0.2

env:
  variables:
    DEPLOY_TIMEOUT: 1800
  parameter-store:
    SLACK_TOKEN: /codebuild/slack_oauth_token

phases:
  install:
    commands:

  build:
    commands:
      # Need to find out how many distributions should be touched
      - set -e
      - CONFIG_JSON='"{\"web.kate.demodjango.uktrade.digital\":[\"/hello/*\", \"/goodbye/*\"], \"api.kate.demodjango.uktrade.digital\":[\"/hello/*\", \"/goodbye/*\"]}"'
      # - CDN_ACCOUNT_ID=""
      
      # Assume cdn account role
      - account_id=$(echo ${ENV_CONFIG} | jq -r '.accounts | .dns.id'
      - echo -e "\nAssume role in ${account_id} account"
      - assumed_role=$(aws sts assume-role --role-arn "arn:aws:iam::${CDN_ACCOUNT_ID}:role/environment-pipeline-assumed-role" --role-session-name "${APPLICATION}-${ENVIRONMENT}-cdn-cache-invalidation")
      - export AWS_ACCESS_KEY_ID=$(echo $assumed_role | jq -r .Credentials.AccessKeyId)
      - export AWS_SECRET_ACCESS_KEY=$(echo $assumed_role | jq -r .Credentials.SecretAccessKey)
      - export AWS_SESSION_TOKEN=$(echo $assumed_role | jq -r .Credentials.SessionToken)
      
      # Invalidate caches
      - |
          DOMAINS=$(echo $CONFIG_JSON | jq -r 'fromjson | keys[]')
          for i in ${DOMAINS}; do
            echo "Getting distribution ID for domain ${i}"
            DISTRIBUTION_ID=$(aws cloudfront list-distributions --query 'DistributionList.Items' --output json | jq -r --arg domain "$i" '.[] | select(.Aliases.Items != null and .Aliases.Items[0] == $domain) | .Id')
            PATHS=$(echo $CONFIG_JSON | jq -r --arg domain ${i} 'fromjson | .[$domain] | join(" ")')
            echo -e "\nInvalidating the cache in distibution id ${DISTRIBUTION_ID} for paths ${PATHS}\n"
          done

  post_build:
    commands:
      - echo "DONE"