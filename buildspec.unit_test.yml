version: 0.2

env:
  parameter-store:
    SLACK_TOKEN: /codebuild/slack_oauth_token
    SLACK_CHANNEL_ID: /codebuild/slack_oauth_channel
    SLACK_CHANNEL_TEST_ID: /codebuild/slack_channel_id_test_command_output

phases:
  install:
    commands:
      - echo -e "\nSetting local Python versions"
      - pyenv versions | awk 'match($0, /[0-9]\.[0-9]+\.[0-9]+/) { print substr($0, RSTART, RLENGTH) }' | tac > .python-version
      - |
        echo -e "\nCheck we are using the latest installed Python 3.x"
        python --version
      - echo -e "\nInstalling dependencies"
      - pip install poetry
      - poetry install
      - pip install dbt-platform-helper

  build:
    commands:
      - echo "Source version is ${CODEBUILD_SOURCE_VERSION}"
      - echo -e "\nRunning pytest unit tests"
      - poetry run tox

  post_build:
    commands:
      - |
        if [ "$(git rev-parse --abbrev-ref HEAD)" == "DBTP-1077-Slack-alerts-for-failing-GitHub-Actions-on-main-branches" ] && [ "${CODEBUILD_BUILD_SUCCEEDING}" == "1" ]; then
          MESSAGE=":alert: @here Unit tests have failed after merge to main in build ${CODEBUILD_BUILD_NUMBER}" 
          
          poetry run platform-helper notify environment-progress "${SLACK_CHANNEL_TEST_ID}" "${SLACK_TOKEN}" "${MESSAGE}" --build-arn "${CODEBUILD_BUILD_ARN}" --repository "platform-tools" --commit-sha "${CODEBUILD_RESOLVED_SOURCE_VERSION}"
        fi
