version: 0.2

env:
  parameter-store:
    SLACK_TOKEN: /codebuild/slack_oauth_token
    SLACK_CHANNEL_ID: /codebuild/slack_oauth_channel

phases:
  install:
    commands:
      - echo -e "\nEnsure Python 3.12.6 is installed for the current user"
      - export PYENV_ROOT="$HOME/.pyenv"
      - if [ -d "$PYENV_ROOT" ]; then rm -rf "$PYENV_ROOT"; fi
      - curl https://pyenv.run | bash
      - export PATH="$PYENV_ROOT/bin:$PATH"
      - eval "$(pyenv init --path)"
      - eval "$(pyenv init -)"
      - pyenv install -s 3.12.6
      - pyenv global 3.12.6 
      - echo -e "\nCreate virtual Python environment"
      - python -m venv --copies venv
      - echo -e "\nActivate virtual Python environment"
      - source venv/bin/activate
      - echo "$VIRTUAL_ENV"
      - python --version
      - which python
      - pip install --upgrade pip
      - pip list

  build:
    commands:
      - echo "Run browser tests"
      - echo "------ FILES DIRECTORY -----------"
      - ls -al
      - platform-helper --version
      - ./regression_tests/stages/set_up_aws_config.sh
      - ./regression_tests/stages/ensure_not_under_maintenance.sh
      - source ./regression_tests/stages/run_demodjango_smoke_tests.sh
      - ./regression_tests/stages/run_maintenance_page_tests.sh

  post_build:
    commands:
      - |
        if [ "${CODEBUILD_BUILD_SUCCEEDING}" != "1" ] && git branch --contains $CODEBUILD_RESOLVED_SOURCE_VERSION | grep -q "main"; then
          MESSAGE=":alert: @here DBT Platform regression tests have failed in <https://eu-west-2.console.aws.amazon.com/codesuite/codebuild/763451185160/projects/platform-tools-test/build/${CODEBUILD_BUILD_ID}/?region=eu-west-2|build ${CODEBUILD_BUILD_NUMBER}> :sob:"
          platform-helper notify add-comment "${SLACK_CHANNEL_ID}" "${SLACK_TOKEN}" "" "${MESSAGE}"
        fi

artifacts:
  files:
    - '**/*'
