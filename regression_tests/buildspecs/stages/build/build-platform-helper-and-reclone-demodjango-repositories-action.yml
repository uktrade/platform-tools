version: 0.2

env:
  parameter-store:
    SLACK_TOKEN: /codebuild/slack_oauth_token
    SLACK_CHANNEL_ID: /codebuild/slack_oauth_channel

phases:
  install:
    commands:
      - exit 1
      - source ./regression_tests/actions/create_virtual_environment.sh

      - source ./regression_tests/actions/set_up_git_config.sh

      - echo -e "\nInstalling dependencies"
      - pip install poetry
      - poetry install

      # The aws-codepipeline Terraform provider does not support setting primary_source,
      # so we cannot get the other codebases we need into the same output artifact
      # without re-cloning them.
      - ./regression_tests/actions/clone_demodjango_deploy.sh
      - ./regression_tests/actions/clone_demodjango.sh
      - cd demodjango && poetry install && cd $CODEBUILD_SRC_DIR

  build:
    commands:
      - ./regression_tests/actions/build_platform_helper.sh

  post_build:
    commands:
      - ./regression_tests/src/send_failure_alerts.sh

artifacts:
  files:
    - '**/*'
